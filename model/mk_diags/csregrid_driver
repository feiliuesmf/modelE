#
# This script administrates the remapping of cubed-sphere modelE
# accumulation arrays to a latlon grid.
#

remap_file=$1 # file containing regridding information
csfile=$2     # the input cubed-sphere acc-file
llfile=$3     # the output latlon acc-file
accn=$4       # name of the acc-array to regrid

#
# Check that the command-line argments are appropriate -
# will be implemented after testing is completed
#

#
# Create an instance of the output acc-array having the correct
# dimension names/sizes
#
imlon=`ncdump -h ${remap_file} | egrep "lon =" | awk '{print $3}'`
jmlat=`ncdump -h ${remap_file} | egrep "lat =" | awk '{print $3}'`
ncwa -h -O -F -y ttl -v ${accn} -a tile -d tile,1 $csfile $llfile
ncrename -h -O -d im,lon -d jm,lat $llfile $llfile
ncdump -h $llfile | sed "s/lon = ../lon = $imlon/; s/lat = ../lat = $jmlat/" > tmpcdl
ncgen -b tmpcdl; rm -f tmpcdl

#
# Copy all the acc-array metadata but its CDL to the output file
#
meta2cpy=ia_${accn},scale_${accn},denom_${accn},sname_${accn},idacc
ncks -h -A -v $meta2cpy $csfile $llfile

#
# Activate the latlon parts of the CDL, remove the
# cubed-sphere parts, and copy to the output file
#
if [[ $imlon -lt 100 ]]; then imlonx=" "$imlon; else imlonx=$imlon; fi
if [[ $jmlat -lt 100 ]]; then jmlatx=" "$jmlat; else jmlatx=$jmlat; fi
ncks -h -O -v cdl_${accn} $csfile tmpcdl.nc
ncdump tmpcdl.nc | \
   egrep -v "global attributes|remove_from_latlon" | \
   sed "s/lon = xxx/lon = $imlonx/; s/lat = xxx/lat = $jmlatx/" | \
   sed "s/.. add_to_latlon /                 /" > tmpcdl
ncgen -b tmpcdl
ncks -h -A -v cdl_${accn} tmpcdl.nc $llfile

#
# If vertical coordinates are needed, copy them to the output file
#
vcoords=` egrep "vertical_coords:" tmpcdl | \
          sed 's/.. vertical_coords://; s/"//g; s/,//' `
for vcoord in $vcoords
do
  ncks -h -A -v $vcoord $csfile $llfile
done

rm -f tmpcdl tmpcdl.nc

#
# Copy horizontal coordinates to the output file
#
ncks -h -A -v lon,lat ${remap_file} $llfile

#
# Now run the regridding program
#
csregrid $remap_file $csfile $llfile $accn
